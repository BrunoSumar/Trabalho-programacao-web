<!DOCTYPE html>
<html lang="pt-br" dir="ltr">

<head>
    <meta charset="utf-8">
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/fa/css/all.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/toggle.css">
    <title>Home</title>
    <title></title>
</head>

<body>


    <nav class="navbar navbar-expand-lg navbar-light ">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse " id="navbarSupportedContent">
            <form class="form-inline mx-auto ">
                <div class="input-group mt-2 search-bar">
                    <input type="text" class="form-control" placeholder="Pesquisar" aria-label="Pesquisar" aria-describedby="button-addon2">
                    <div class="input-group-append">
                        <button class="btn " type="button" id="button-addon2">

                            <i class="fas fa-search mx-3 my-1"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </nav>

    <div class="row" style="margin:0px;">
        <div class="col-sm-2 shadow-lg" style="padding:0px;" id="sidebar">
            <div class="row" style="margin:0px;">
                <img src="svg/isologo.svg" class="card-img-top py-4 px-4 m-0" alt="..." style="display:block">

                <button id="newBookmark" class="text-light gradient-rosa btn  btn-block font-weight-bold borderless" type="submit" data-toggle="modal" data-target="#bookmarkModal">
                    <i class="fas fa-plus-circle"></i>
                    New</button>
                <ul class="nav text-white-50">
                    <li class="nav-item">
                        <a class="nav-link active text-white-50" href="#">
                            <svg class="bi bi-person-bounding-box" version="1.1" viewBox="0 0 576 512.62" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="1em" height="1em">
                                <path fill-rule="evenodd" d="m570.69 236.27-58.69-51.83v-136.44c0-8.8366-7.1634-16-16-16h-64c-8.8366 0-16 7.1634-16 16v51.67l-101.22-89.37c-6.28-5.69-18.25-10.3-26.78-10.3s-20.46 4.61-26.74 10.3l-256 226c-3.1542 3.1868-5.0263 7.4223-5.26 11.9 0.20437 3.911 1.6354 7.6583 4.09 10.71l21.41 23.79c3.3368 2.9945 7.5392 4.8505 12 5.3 3.8674-0.38654 7.5597-1.8061 10.69-4.11l15.9-14v210.11c0 17.673 14.327 32 32 32h120.55c0.86929-14.71-1.1443-104.04 0-128.38 0-17.608 92.274-19.556 92.29 1.5474 0.0206 27.213-0.016 115.43-0.63578 127.46l171.7-0.62197c17.673-0.064 32-14.327 32-32v-210.12l15.91 14c3.1441 2.3008 6.8442 3.7228 10.72 4.12 4.4208-0.46209 8.579-2.3222 11.87-5.31l21.41-23.81c2.298-3.1317 3.7108-6.8242 4.09-10.69-0.45927-4.4364-2.3191-8.6114-5.31-11.92z" />
                            </svg>
                            Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white-50" href="#"><i class="fas fa-search"></i> Search</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white-50" href="#"><i class="fas fa-bookmark"></i> My Bookmarks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white-50" href="#">
                            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-person-bounding-box" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M1.5 1a.5.5 0 0 0-.5.5v3a.5.5 0 0 1-1 0v-3A1.5 1.5 0 0 1 1.5 0h3a.5.5 0 0 1 0 1h-3zM11 .5a.5.5 0 0 1 .5-.5h3A1.5 1.5 0 0 1 16 1.5v3a.5.5 0 0 1-1 0v-3a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 1-.5-.5zM.5 11a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 1 0 1h-3A1.5 1.5 0 0 1 0 14.5v-3a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v3a1.5 1.5 0 0 1-1.5 1.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 1 .5-.5z" />
                                <path fill-rule="evenodd" d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                            </svg>
                            Profile</a>
                    </li>
                    <li class="nav-item relative-bottom mb-5">
                        <a class="nav-link text-white-50" href="#"><i class="fas fa-sign-out-alt"></i> Exit</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-sm-10 content">
            <div class="col">
                <div class="container-fluid text-light rounded-lg mt-5" id="myBookmarks">

                </div>
            </div>
        </div>
    </div>





    <!-- Modal Bookmark-->
    <div class="modal  fade" id="bookmarkModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h5 class="modal-title bookmarkForm" id="modalTitle">BOOKMARK</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body bookmarkForm">
                    <form id="bookmarkForm" method="post">
                        <div class="form-group">
                            <input type="text" class="form-control bookmarkForm" id="titleBookmark" name="titleBookmark" required="" autocomplete="off">
                            <label class="bookmarkForm" for="titleBookmark">Title</label>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control bookmarkForm" id="notesBookmark" name="notesBookmark" required="" autocomplete="off">
                            <label for="message-text" class="bookmarkForm">Notes</label>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control bookmarkForm" id="urlBookmark" name="urlBookmark" required="" autocomplete="off">
                            <label for="message-text" class="bookmarkForm">URL</label>
                        </div>
                        <div class="form-group toogle">
                            <!-- <span for="">Public</span> -->
                            <!-- <input type="checkbox" id="isPublic" checked /><label for="isPublic">Private?</label> -->
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="isPublic" name="isPublic" checked>
                                <label class="custom-control-label" for="isPublic">Public</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <p id="creation_date" for="message-text" class="bookmarkForm"></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                        <input type="hidden" name="hidden_id" id="hidden_id" value="1">
                        <input type="hidden" name="thumb_id" id="thumb_id" value="1">
                        <input type="hidden" name="action" id="action" value="">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h5 class="modal-title bookmarkForm" id="exampleModalLabel"><i class="fas fa-times text-danger"></i> Delete Bookmark?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center" id="deleteModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button id="deleteBookmark" type="submit" class="btn btn-danger" value="">Delete</button>
                </div>
            </div>
        </div>
    </div>




    <!-- Optional JavaScript -->
    <script type="text/javascript">
        let version = 0,
            atual = 1
        document.addEventListener("DOMContentLoaded", function(event) {

            const addButton = document.getElementById('newBookmark');
            const deleteButton = document.getElementById('deleteBookmark');
            const form = document.getElementById("bookmarkForm");

            let editButtons = document.getElementsByClassName("edit");
            let version = null;

            function sendData() {
                const XHR = new XMLHttpRequest();
                const FD = new FormData(form);
                //console.log(FD);
                XHR.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        console.log(XHR.response);
                    }
                }
                XHR.open("POST", "application/validateBookmark.php");
                XHR.send(FD);
            }

            function is_update() {
                let xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        atual = this.responseText;
                    }
                };
                xmlhttp.open("GET", "API/testedb.php?action=4", true);
                xmlhttp.send();
                if (version == atual)
                    return true;

                version = atual;
                return false;

            }

            function listBookmars() {
                let xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        document.getElementById("myBookmarks").innerHTML = this.responseText;
                        onclickButtonsEdit();
                        onclickButtonsDelete();
                    }
                };
                xmlhttp.open("GET", "components/listBookmarks.php", true);
                xmlhttp.send();
            }

            function deleteBookmark(id) {
                const XHR = new XMLHttpRequest();
                XHR.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        console.log(XHR.response);
                    }
                }
                let data = `action=delete_by_id&id=${id}`;
                XHR.open("POST", "application/validateBookmark.php");
                XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                XHR.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                XHR.send(data);
            }

            async function loop() {
                while (true) {
                    await new Promise(_ => setTimeout(_, 1000));
                    if (!is_update()) {
                        listBookmars();
                        console.log('.');
                    }
                }
            }

            function onclickButtonsEdit() {
                editButtons = document.getElementsByClassName("edit");
                for (let i = 0; i < editButtons.length; i++) {
                    editButtons[i].onclick = function() {
                        const XHR = new XMLHttpRequest();
                        XHR.onreadystatechange = function() {
                            if (this.readyState == 4 && this.status == 200) {
                                //console.log(XHR.response);
                                const data = JSON.parse(XHR.response)[0];
                                document.getElementById('modalTitle').innerHTML = '<i class="far fa-edit"></i> Edit Bookmark';
                                document.getElementById('titleBookmark').value = data['title'];
                                document.getElementById('notesBookmark').value = data['notes'];
                                document.getElementById('urlBookmark').value = data['url'];
                                document.getElementById('hidden_id').value = data['bookmark_id'];
                                document.getElementById('thumb_id').value = data['thumb_id'];
                                document.getElementById('creation_date').innerHTML = `<b>Create:</b> ${data['creation_date']}`;
                                document.getElementById('action').value = 'update';
                            }
                        }
                        let data = `action=fetch_one_by_id&id=${this.id}`;
                        XHR.open("POST", "application/validateBookmark.php");
                        XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        XHR.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                        XHR.send(data);

                    };
                }

            }

            function onclickButtonsDelete() {
                deleteButtons = document.getElementsByClassName("delete");
                for (let i = 0; i < deleteButtons.length; i++) {
                    deleteButtons[i].onclick = function() {
                        const XHR = new XMLHttpRequest();
                        XHR.onreadystatechange = function() {
                            if (this.readyState == 4 && this.status == 200) {
                                //console.log(XHR.response);
                                const data = JSON.parse(XHR.response)[0];
                                document.getElementById('deleteModalBody').innerHTML = `Deseja realmente deletar <br>"${data["title"]}"?`;
                                deleteButton.value = data["bookmark_id"];
                            }
                        }
                        let data = `action=fetch_one_by_id&id=${this.id}`;
                        XHR.open("POST", "application/validateBookmark.php");
                        XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        XHR.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                        XHR.send(data);
                    }
                }
            }

            //Vou analisar no futuro
            {
                function postAjax(url, data, success) {
                    var params = typeof data == 'string' ? data : Object.keys(data).map(
                        function(k) {
                            return encodeURIComponent(k) + '=' + encodeURIComponent(data[k])
                        }
                    ).join('&');

                    var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
                    xhr.open('POST', url);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState > 3 && xhr.status == 200) {
                            success(xhr.responseText);
                        }
                    };
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.send(params);
                    return xhr;
                }
                // example request
                // postAjax("application/validateBookmark.php", 'p1=1&p2=Hello+World', function(data) {
                //     console.log(data);
                // });

                // example request with data object
                // postAjax("application/validateBookmark.php", {
                //     p1: 1,
                //     p2: 'Hello World'
                // }, function(data) {
                //     console.log(data);
                // });

            }

            // let data1 = {
            //     oi: 1,
            //     oi2: 32
            // };
            // var params = typeof data1 == 'string' ? data1 : Object.entries(data1).map(
            //     function(k) {
            //         return encodeURIComponent(k[0]) + '=' + encodeURIComponent(k[1])
            //     }
            // ).join('&');
            // console.log(params);

            addButton.onclick = function() {
                //console.log('add');
                document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus"></i> New Bookmark';
                document.getElementById('creation_date').innerHTML = null;
                document.getElementById('titleBookmark').value = null;
                document.getElementById('notesBookmark').value = null;
                document.getElementById('urlBookmark').value = null;
                document.getElementById('hidden_id').value = null;
                document.getElementById('isPublic').checked = true;
                document.getElementById('action').value = 'insert';
                return false;
            };

            deleteButton.onclick = function() {
                deleteBookmark(this.value);
                $('#deleteModal').modal('toggle')
                return false;
            };



            form.addEventListener("submit", function(event) {
                event.preventDefault();
                sendData();
                addButton.click();
            });

            //addButton.click();
            listBookmars();
            loop();
        });
    </script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="js/jquery-3.5.1.slim.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script> -->
    <script src="js/bootstrap.min.js"></script>

</body>

</html>